---
title: "flode simulation results"
author: "Julia Wrobel"
date: '`r format(Sys.time(), "%Y-%m-%d")`'
output:
  html_document: 
    code_folding: hide
    toc: true
    toc_float: true
hitheme: tomorrow
highlighter: highlight.js
---

# Overview

This file loads data objects stored from simulations and creates Figures 2,3,4, and 5 from the manuscript. Libraries and code are sourced below.

```{r setup, message=FALSE, warning=FALSE}
library(tidyverse)
library(stringr)
library(splines)
library(refund)
library(mvtnorm)
library(patchwork)
library(pracma)
library(latex2exp)
library(viridis)


knitr::opts_chunk$set(echo = TRUE,
  warning = FALSE,
  message = FALSE,
  fig.width = 9,
  fig.height = 4,
  fig.path = '../output/'
)

theme_set(theme_bw() + theme(legend.position = "bottom"))

source(here::here("preprocessing", "simulated_paw.R"))
source(here::here("preprocessing", "pffr_sim.R"))
source(here::here("preprocessing", "make_pffr.R"))
source(here::here("preprocessing", "estimate_flode.R"))
source(here::here("preprocessing", "utils.R"))
source(here::here("preprocessing", "search_alpha.R"))
source(here::here("preprocessing", "predict_flode.R"))
```



# Load simulation data


Results were generated by files in `preprocessing/simulations/` folder and pulled together by `preprocessing/simulations/process_sim_files.R`.


```{r}
load(file = here::here("output", "sim_results.Rdata"))
```



Below we do some further data processing.

```{r}
df  = df %>%
	  mutate(alpha = factor(alpha_true, 
	                        levels = c(0.1,0.5,1,2,4,6,8,10,12),
	  											labels = paste0(c(0.1,0.5,1,2,4,6,8,10,12))))

```



# Figures

## Figure 2

## Figure 3

This produces Figure 3 in the manuscript, and saves it to the `output` folder as `fig_sim_alpha-1.png`.


```{r fig_sim_alpha, fig.width = 10}
load(file = here::here("output", "alpha_ests.R"))
alpha_ests = alpha_ests  %>%
  mutate(measure = "alpha_bias",
         value = alpha_true - alpha_est) %>%
  select(iter, alpha_true, measure, value)

beta_ests = df %>%
  filter(alpha_true %in% c(0.1, 0.5, 1, 4, 8, 12),
         genMod == "flode") %>%
  select(iter, alpha_true, ISEb0, ISEb1) %>%
  pivot_longer(ISEb0:ISEb1, names_to = "measure", values_to = "value")

bind_rows(alpha_ests, beta_ests) %>%
  mutate(measure = factor(measure, 
                          levels = c("alpha_bias", "ISEb0", "ISEb1"),
                          labels = c("alpha-hat(alpha)", TeX("$\\int_t\\{\\beta_0(t)-\\hat{\\beta}_0(t)\\}dt$"), TeX("$\\int_t\\{\\beta_1(t)-\\hat{\\beta}_1(t)\\}dt$")))) %>%
  mutate(alpha = factor(alpha_true)) %>%
  ggplot(aes(alpha, value, group = alpha)) +
  geom_violin() +
  geom_hline(yintercept = 0, linetype = 2) +
  labs(x = expression(paste("true ", alpha)), y = "error") +
  facet_wrap(~measure, scales = "free_y",
             labeller = label_parsed)

```


## Figure 4

This produces Figure 4 in the manuscript, and saves it to the `output` folder as `fig_sim_surfaceErr-1.png`.
This figure is a comparison of flode, fhist, and fconc.


### Surfaces

Generate true surfaces for flode, for fhist, and show fitted values from one dataset for both.

```{r fig_sim_surfaceErr, fig.width = 10, fig.height = 8}
p1 = surface_df %>%
  filter(alpha %in% c(0.1, 0.5, 1, 4, 8, 12)) %>%
  mutate(alpha = as.character(alpha)) %>%
  bind_rows(., mutate(surfaceGenFhist_df, alpha = "fhist")) %>%
  mutate(alpha = factor(alpha, levels = c("0.1", "0.5", "1", "4",
                                          "8", "12", "fhist"),
                        labels = c("alpha: 0.1", "alpha: 0.5", "alpha: 1", 
                                   "alpha: 4","alpha: 8", 
                                   "alpha: 12", "fhist")),
         method = factor(method, levels = c("truth", "flode", "fhist"))) %>%
  ggplot(aes(s, t, fill = value)) +
  geom_tile() +
  scale_fill_viridis() +
  theme(legend.position = "right") +
  facet_grid(method~alpha, labeller = label_parsed)



p2 = bind_rows(select(df, iter, alpha = alpha_true, genMod, contains("surfaceErr")),
          select(df_fhist, iter, alpha = alpha_true, genMod, contains("surfaceErr"))) %>%
  filter(alpha %in% c(0.1, 0.5, 1, 4, 8, 12)) %>%
  mutate(alpha = as.character(alpha),
         alpha = ifelse(genMod == "fhist", "fhist", alpha),
         alpha = factor(alpha, levels = c("0.1", "0.5", "1", "4",
                                          "8", "12", "fhist"),
                        labels = c("alpha: 0.1", "alpha: 0.5", "alpha: 1", 
                                   "alpha: 4","alpha: 8", 
                                   "alpha: 12", "fhist"))) %>%
  pivot_longer(surfaceErr_flode:surfaceErr_fhist, names_to = "model", values_to = "ISE", names_prefix = "surfaceErr_") %>%
  mutate(logISE = log(ISE),
         model = factor(model, levels = c("flode", "fhist", "fconc"))) %>%
    ggplot(aes(model, logISE, group = model, fill = model)) +
  geom_boxplot() +
  theme(legend.position = "none",
        axis.title.x = element_blank()) +
  labs(y = "log ISE") +
  scale_fill_brewer(drop = FALSE, type = "div", palette = 4) +
  #scale_fill_manual(drop = FALSE, values = c("red", "blue", "green")) +
  facet_wrap(~alpha, scales = "free", nrow = 1,
             labeller = label_parsed)


         
df_pred_fhist = df_pred_fhist %>% 
    mutate(alpha = "fhist") %>%
    select(iter, alpha, contains("mae")) %>%
    pivot_longer(flode_mae:fhist_mae, names_to = "model", values_to = "MAPE") 
  

p3 = df_pred %>%
  filter(!is.na(flode_mae)) %>%
    mutate(alpha = as.character(alpha_true)) %>%
  select(iter, alpha, contains("mae")) %>%
  pivot_longer(flode_mae:fhist_mae, names_to = "model", 
               values_to = "MAPE") %>%
  bind_rows(., df_pred_fhist) %>%
  mutate(model = str_remove(model, "_mae"),
         logMAPE = log(MAPE),
         model = factor(model, levels = c("flode", "fhist", "fconc"))) %>%
    mutate(alpha = factor(alpha, levels = c("0.1", "0.5", "1", "4",
                                          "8", "12", "fhist"),
                        labels = c("alpha: 0.1", "alpha: 0.5", "alpha: 1", 
                                   "alpha: 4","alpha: 8", 
                                   "alpha: 12", "fhist"))) %>%
  ggplot(aes(model, logMAPE, group = model, fill = model)) +
  geom_boxplot() +
  theme(legend.position = "none",
        axis.title.x = element_blank()) +
  labs(y = "log MAPE") +
  scale_fill_brewer(drop = FALSE, type = "div") +
  facet_wrap(~alpha, scales = "free", nrow = 1,
             labeller = label_parsed)


p1/p2/p3 + plot_layout(heights = c(2.5,1,1))
```

